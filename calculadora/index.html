<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora</title>
  <link rel="icon" type="image/png" sizes="32x32" href="">

  <!-- Bloqueio de cache para evitar reuso de páginas protegidas -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Flatpickr CSS (tema escuro) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

  <script>
    // Redireciona imediatamente se tentar acessar direto
    if (document.referrer === "" || document.referrer === window.location.href) {
      window.location.replace("https://almoxarifadobotucatu.netlify.app/");
    }
  </script>

  <script>
    (function() {
      const LOGIN = "https://almoxarifadobotucatu.netlify.app/";
      const CENTRAL = "https://almoxarifadobotucatu.netlify.app/central-de-pedidos/";

      const ref = document.referrer || "";
      if (!ref.startsWith(CENTRAL)) {
        try {
          // Limpa dados do domínio
          localStorage.clear();
          sessionStorage.clear();
          document.cookie.split(';').forEach(c => {
            const eq = c.indexOf('=');
            const name = (eq > -1 ? c.substr(0, eq) : c).trim();
            if (name) document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
          });
          if ('caches' in window) { caches.keys().then(keys => keys.forEach(k => caches.delete(k))); }
          if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister())); }
        } catch (e) {}
        window.location.replace(LOGIN);
        return;
      }

      // Bloqueio do botão voltar
      try { history.replaceState({guard:1}, "", location.href); } catch(_) {}
      try { history.pushState({guard:2}, "", location.href); } catch(_) {}
      addEventListener("popstate", function(){ window.location.replace(LOGIN); });

      window.addEventListener("pageshow", function(ev) {
        if (ev.persisted) { window.location.replace(LOGIN); }
      });
    })();
  </script>

  <script>
    // Manipulação de data (campo "endDate")
    document.getElementById("endDate").addEventListener("input", function(e) {
      let value = e.target.value.replace(/\D/g, ""); // Remove caracteres não numéricos
      if (value.length > 2 && value.length <= 4) value = value.replace(/(\d{2})(\d+)/, "$1/$2");
      else if (value.length > 4) value = value.replace(/(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
      e.target.value = value;
    });
  </script>

  <script>
    // ====== LOGOUT: limpar tudo e ir para a página de login ======
    // BOTÃO SAIR - mesmo do central de pedidos
    (function(){
      var sair = document.getElementById("btnSair");
      if (sair) {
        sair.addEventListener("click", async function(e) {
          e.preventDefault();
          try {
            // Limpa storage
            localStorage.clear();
            sessionStorage.clear();
            document.cookie.split(';').forEach(c => {
              const eq = c.indexOf('=');
              const name = (eq > -1 ? c.substr(0, eq) : c).trim();
              if (name) document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            });
            if ('caches' in window) {
              const keys = await caches.keys();
              for (let key of keys) { await caches.delete(key); }
            }
            if ('serviceWorker' in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              for (const reg of regs) { try { await reg.unregister(); } catch (_) {} }
            }
          } catch (_) {}
          window.location.replace("https://almoxarifadobotucatu.netlify.app/");
        });
      }
    })();

    // ====== BOTÃO VOLTAR do navegador: sempre mandar para login ======
    (function(){
      // Cria uma entrada falsa no histórico; ao pressionar "voltar", cairemos no popstate
      try { history.pushState({blockBack:true}, "", window.location.href); } catch(_) {}

      window.addEventListener("popstate", function () {
        window.location.replace("https://almoxarifadobotucatu.netlify.app/");
      });

      // Trata o BFCache do Chrome/Firefox: se a página voltar do cache (navegação back/forward), manda para login
      window.addEventListener("pageshow", function (event) {
        try {
          const nav = performance.getEntriesByType && performance.getEntriesByType("navigation")[0];
          const isBFCache = event.persisted || (nav && nav.type === "back_forward");
          if (isBFCache) {
            window.location.replace("https://almoxarifadobotucatu.netlify.app/");
          }
        } catch(_) {}
      });
    })();
  </script>
</head>
<body>
  <h1>45 Dias Úteis Retroativos</h1>

  <!-- Restante do conteúdo da sua página -->

  <footer style="position: fixed; bottom: 4px; right: 4px; font-size: 9px; color: #888; background: transparent; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; opacity: 0.75; user-select: none;">
    <!-- Footer Content -->
  </footer>
</body>
</html>
