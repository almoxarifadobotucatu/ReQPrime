<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Pedidos Extras</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: #1a1a2e;
      color: #fff;
    }
    .topbar {
      text-align: center;
      padding: 20px;
      background: #16213e;
      border-bottom: 2px solid #0a66c2;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    .topbar h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 20px;
      max-width: 1400px;
      margin: auto;
    }
    .card {
      background: #16213e;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .card div:first-child {
      color: #b8b8b8;
      font-size: .9rem;
    }
    .card div:last-child {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #16213e;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #2a2a3a;
    }
    th {
      background: #0a66c2;
      color: #fff;
    }
    tr:hover td {
      background: rgba(255,255,255,0.05);
    }
    .gate {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }
    select, button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    select {
      background: #fff;
      color: #000;
      min-width: 240px;
    }
    button {
      background: #0a66c2;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.3s ease;
    }
    button:hover {
      background: linear-gradient(270deg,#0a66c2,#1db954);
      background-size: 600% 600%;
      animation: gradientShift 6s ease infinite;
      transform: translateY(-2px);
    }
    #resetPedidosBtn {
      background: #e53e3e;
      margin-left: 20px;
    }
    #resetPedidosBtn:hover {
      background: linear-gradient(270deg,#e53e3e,#ff6b6b);
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üìä Dashboard de Pedidos Extras</h1>
    <button id="resetPedidosBtn">Resetar Pedidos</button>
  </div>

  <!-- Seletor de unidade -->
  <div class="gate">
    <label for="unidadeSelect">Selecione a unidade de sa√∫de:</label>
    <select id="unidadeSelect">
      <option value="">Todas</option>
    </select>
    <button id="confirmarUnidade">Carregar</button>
  </div>

  <!-- KPIs -->
  <section class="cards">
    <div class="card">
      <div>Total de pedidos</div>
      <div id="kpiTotal">‚Äî</div>
    </div>
    <div class="card">
      <div>Hoje</div>
      <div id="kpiHoje">‚Äî</div>
    </div>
    <div class="card">
      <div>√öltimos 7 dias</div>
      <div id="kpi7d">‚Äî</div>
    </div>
    <div class="card">
      <div>Pendentes</div>
      <div id="kpiPendentes">‚Äî</div>
    </div>
  </section>

  <!-- Tabela -->
  <div style="padding:20px; max-width:1400px; margin:auto;">
    <table>
      <thead>
        <tr>
          <th>Respons√°vel</th>
          <th>Unidade de Sa√∫de</th>
          <th>Item</th>
          <th>Quantidade</th>
          <th>Unidade de Controle</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="tabelaPedidos">
        <tr><td colspan="6" style="text-align:center;">Selecione uma unidade para carregar os pedidos...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdB4pI610z1rplKmfAHct7CmGD0vmBg3U",
      authDomain: "almoxarifadobotucatu-5e03d.firebaseapp.com",
      projectId: "almoxarifadobotucatu-5e03d",
      storageBucket: "almoxarifadobotucatu-5e03d.firebasestorage.app",
      messagingSenderId: "828951000388",
      appId: "1:828951000388:web:06dbe3cb5764872e7b1311"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const unidadeSelect = document.getElementById("unidadeSelect");
    const confirmarBtn = document.getElementById("confirmarUnidade");
    const tabela = document.getElementById("tabelaPedidos");

    function toDate(any) {
      if (!any) return null;
      if (any.seconds) return new Date(any.seconds * 1000);
      return new Date(any);
    }

    async function carregarUnidades(pedidos) {
      unidadeSelect.innerHTML = '<option value="">Todas</option>'; // <-- limpa antes
      const unidades = new Set(pedidos.map(p => p.unidade));
      unidades.forEach(u => {
        if (u) {
          const opt = document.createElement("option");
          opt.value = u;
          opt.textContent = u;
          unidadeSelect.appendChild(opt);
        }
      });
    }

    async function carregarPedidos(unidade) {
      const pedidosRef = collection(db, "pedidos");
      const snapshot = await getDocs(pedidosRef);
      const pedidos = [];

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.itens && data.itens.length > 0) {
          data.itens.forEach(item => {
            pedidos.push({
              solicitante: data.solicitante,
              unidade: data.unidade,
              item: item.nome,
              quantidade: item.quantidade,
              unidadeControle: item.unidadeControle,
              data: toDate(data.data)
            });
          });
        }
      });

      pedidos.sort((a,b)=>(b.data?.getTime?.()||0) - (a.data?.getTime?.()||0));
      const filtrados = unidade ? pedidos.filter(p => p.unidade === unidade) : pedidos;

      document.getElementById("kpiTotal").textContent = filtrados.length;
      const hojeKey = new Date().toDateString();
      document.getElementById("kpiHoje").textContent = filtrados.filter(p=>p.data && p.data.toDateString()===hojeKey).length;
      document.getElementById("kpi7d").textContent = filtrados.filter(p=>p.data && (new Date()-p.data)<=7*24*60*60*1000).length;
      document.getElementById("kpiPendentes").textContent = filtrados.filter(p=>(p.status||"").toLowerCase().includes("pend")).length;

      tabela.innerHTML = ""; // <-- garante que limpa antes de renderizar
      filtrados.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.solicitante||"‚Äî"}</td>
          <td>${p.unidade||"‚Äî"}</td>
          <td>${p.item||"‚Äî"}</td>
          <td>${p.quantidade||"‚Äî"}</td>
          <td>${p.unidadeControle||"‚Äî"}</td>
          <td>${p.data? p.data.toLocaleString():"‚Äî"}</td>
        `;
        tabela.appendChild(tr);
      });
    }

    confirmarBtn.addEventListener("click", ()=> {
      const unidade = unidadeSelect.value;
      carregarPedidos(unidade);
    });

    // inicializar (apenas carrega unidades, sem renderizar duplicado)
    (async ()=>{
      const pedidosRef = collection(db, "pedidos");
      const snapshot = await getDocs(pedidosRef);
      const pedidos = [];
      snapshot.forEach(docSnap => pedidos.push(docSnap.data()));
      carregarUnidades(pedidos);
    })();

    // resetar pedidos
    const resetBtn = document.getElementById("resetPedidosBtn");
    resetBtn.addEventListener("click", async () => {
      if (confirm("‚ö†Ô∏è Tem certeza que deseja apagar TODOS os pedidos do Firebase?")) {
        try {
          const pedidosRef = collection(db, "pedidos");
          const snapshot = await getDocs(pedidosRef);
          for (const d of snapshot.docs) {
            await deleteDoc(doc(db, "pedidos", d.id));
          }
          alert("‚úÖ Todos os pedidos foram apagados!");
          tabela.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Nenhum pedido encontrado</td></tr>";
          document.getElementById("kpiTotal").textContent = "0";
          document.getElementById("kpiHoje").textContent = "0";
          document.getElementById("kpi7d").textContent = "0";
          document.getElementById("kpiPendentes").textContent = "0";
        } catch (err) {
          console.error("Erro ao resetar pedidos:", err);
          alert("‚ùå Erro ao resetar pedidos.");
        }
      }
    });
  </script>
</body>
</html>
