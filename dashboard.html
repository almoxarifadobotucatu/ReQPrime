<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Pedidos Extras</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: #1a1a2e;
      color: #fff;
    }
    .topbar {
      text-align: center;
      padding: 20px;
      background: #16213e;
      border-bottom: 2px solid #0a66c2;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .topbar h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 20px;
      max-width: 1400px;
      margin: auto;
    }
    .card {
      background: #16213e;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .card div:first-child {
      color: #b8b8b8;
      font-size: .9rem;
    }
    .card div:last-child {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #16213e;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #2a2a3a;
    }
    th {
      background: #0a66c2;
      color: #fff;
    }
    tr:hover td {
      background: rgba(255,255,255,0.05);
    }
    .gate {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    select, button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    select {
      background: #fff;
      color: #000;
      min-width: 240px;
    }
    button {
      background: #0a66c2;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(270deg,#0a66c2,#1db954);
      background-size: 600% 600%;
      animation: gradientShift 6s ease infinite;
      transform: translateY(-2px);
    }
    #resetPedidosBtn {
      background: #e53e3e;
    }
    #resetPedidosBtn:hover:not(:disabled) {
      background: linear-gradient(270deg,#e53e3e,#ff6b6b);
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }
    .msg {
      max-width: 1400px;
      margin: 12px auto 0;
      padding: 10px 14px;
      border-radius: 10px;
      display: none;
    }
    .msg.ok { background: #153e2b; border:1px solid #2f855a; color: #c6f6d5; }
    .msg.err { background: #3e1515; border:1px solid #c53030; color: #fed7d7; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>📊 Dashboard de Pedidos Extras</h1>
    <button id="resetPedidosBtn" title="Apaga todos os documentos da coleção 'pedidos'">Resetar Pedidos</button>
  </div>

  <div id="flash" class="msg"></div>

  <!-- Seletor de unidade -->
  <div class="gate">
    <label for="unidadeSelect">Selecione a unidade de saúde:</label>
    <select id="unidadeSelect">
      <option value="">Todas</option>
    </select>
    <button id="confirmarUnidade">Carregar</button>
  </div>

  <!-- KPIs -->
  <section class="cards">
    <div class="card">
      <div>Total de pedidos</div>
      <div id="kpiTotal">—</div>
    </div>
    <div class="card">
      <div>Hoje</div>
      <div id="kpiHoje">—</div>
    </div>
    <div class="card">
      <div>Últimos 7 dias</div>
      <div id="kpi7d">—</div>
    </div>
    <div class="card">
      <div>Pendentes</div>
      <div id="kpiPendentes">—</div>
    </div>
  </section>

  <!-- Tabela -->
  <div style="padding:20px; max-width:1400px; margin:auto;">
    <table>
      <thead>
        <tr>
          <th>Responsável</th>
          <th>Unidade de Saúde</th>
          <th>Item</th>
          <th>Quantidade</th>
          <th>Unidade de Controle</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="tabelaPedidos">
        <tr><td colspan="6" style="text-align:center;">Selecione uma unidade para carregar os pedidos...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // TODO: confirme as credenciais do seu projeto
    const firebaseConfig = {
      apiKey: "AIzaSyCdB4pI610z1rplKmfAHct7CmGD0vmBg3U",
      authDomain: "almoxarifadobotucatu-5e03d.firebaseapp.com",
      projectId: "almoxarifadobotucatu-5e03d",
      storageBucket: "almoxarifadobotucatu-5e03d.firebasestorage.app",
      messagingSenderId: "828951000388",
      appId: "1:828951000388:web:06dbe3cb5764872e7b1311"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const unidadeSelect = document.getElementById("unidadeSelect");
    const confirmarBtn = document.getElementById("confirmarUnidade");
    const tabela = document.getElementById("tabelaPedidos");
    const flash = document.getElementById("flash");
    const resetBtn = document.getElementById("resetPedidosBtn");

    function toDate(any) {
      if (!any) return null;
      if (any.seconds) return new Date(any.seconds * 1000);
      const d = new Date(any);
      return isNaN(d) ? null : d;
    }

    function showMsg(text, type="ok", ms=2500){
      flash.textContent = text;
      flash.className = "msg " + (type==="ok" ? "ok" : "err");
      flash.style.display = "block";
      setTimeout(()=>{ flash.style.display = "none"; }, ms);
    }

    async function obterPedidosSnapshot() {
      const pedidosRef = collection(db, "pedidos");
      return await getDocs(pedidosRef);
    }

    function montarLinhas(snapshot, unidade) {
      const linhas = [];
      const seen = new Set(); // evita duplicações idênticas

      snapshot.forEach(docSnap => {
        const data = docSnap.data() || {};
        if (unidade && data.unidade !== unidade) return;

        const itens = Array.isArray(data.itens) ? data.itens : [];

        itens.forEach((item, idx) => {
          const row = {
            solicitante: data.solicitante || "—",
            unidade: data.unidade || "—",
            item: (item && item.nome) || "—",
            quantidade: (item && item.quantidade) ?? "—",
            unidadeControle: (item && item.unidadeControle) || "—",
            data: toDate(data.data)
          };

          // chave única baseada no documento + conteúdo do item
          const key = [
            docSnap.id,
            row.solicitante,
            row.unidade,
            row.item,
            row.quantidade,
            row.unidadeControle,
            row.data ? row.data.getTime() : ""
          ].join("|");

          if (!seen.has(key)) {
            seen.add(key);
            linhas.push(row);
          }
        });
      });

      // ordena por data desc
      linhas.sort((a,b)=>(b.data?.getTime?.()||0) - (a.data?.getTime?.()||0));
      return linhas;
    }

    function renderTabela(linhas) {
      tabela.innerHTML = "";
      if (!linhas.length) {
        tabela.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Nenhum pedido encontrado</td></tr>";
        return;
      }
      const frag = document.createDocumentFragment();
      for (const p of linhas) {
        const tr = document.createElement("tr");
        tr.innerHTML = \`
          <td>\${p.solicitante}</td>
          <td>\${p.unidade}</td>
          <td>\${p.item}</td>
          <td>\${p.quantidade}</td>
          <td>\${p.unidadeControle}</td>
          <td>\${p.data ? p.data.toLocaleString() : "—"}</td>
        \`;
        frag.appendChild(tr);
      }
      tabela.appendChild(frag);
    }

    async function carregarUnidades() {
      const snapshot = await obterPedidosSnapshot();
      // limpar opções antes de popular
      unidadeSelect.innerHTML = '<option value="">Todas</option>';
      const unidades = new Set();
      snapshot.forEach(docSnap => {
        const u = (docSnap.data() || {}).unidade;
        if (u) unidades.add(u);
      });
      [...unidades].sort().forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        unidadeSelect.appendChild(opt);
      });
    }

    async function carregarPedidos(unidade) {
      confirmarBtn.disabled = true;
      try {
        const snapshot = await obterPedidosSnapshot();
        const linhas = montarLinhas(snapshot, unidade);
        // KPIs
        document.getElementById("kpiTotal").textContent = linhas.length;
        const hojeKey = new Date().toDateString();
        document.getElementById("kpiHoje").textContent = linhas.filter(p=>p.data && p.data.toDateString()===hojeKey).length;
        document.getElementById("kpi7d").textContent = linhas.filter(p=>p.data && (new Date()-p.data)<=7*24*60*60*1000).length;
        document.getElementById("kpiPendentes").textContent = linhas.filter(p=> (p.status||"").toLowerCase().includes("pend")).length;
        // Tabela
        renderTabela(linhas);
      } finally {
        confirmarBtn.disabled = false;
      }
    }

    confirmarBtn.addEventListener("click", ()=> {
      const unidade = unidadeSelect.value;
      carregarPedidos(unidade);
    }, { once: false });

    // inicializar
    (async ()=>{
      await carregarUnidades();
    })();

    // RESET pedidos
    resetBtn.addEventListener("click", async () => {
      if (!confirm("⚠️ Tem certeza que deseja apagar TODOS os documentos da coleção 'pedidos'?")) return;
      resetBtn.disabled = true;
      try {
        const snapshot = await obterPedidosSnapshot();
        const total = snapshot.size;
        for (const d of snapshot.docs) {
          await deleteDoc(doc(db, "pedidos", d.id));
        }
        showMsg(`✅ ${total} pedido(s) apagado(s).`, "ok");
        // Limpa UI
        renderTabela([]);
        document.getElementById("kpiTotal").textContent = "0";
        document.getElementById("kpiHoje").textContent = "0";
        document.getElementById("kpi7d").textContent = "0";
        document.getElementById("kpiPendentes").textContent = "0";
        await carregarUnidades();
      } catch (err) {
        console.error(err);
        showMsg("❌ Erro ao resetar pedidos.", "err");
      } finally {
        resetBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
