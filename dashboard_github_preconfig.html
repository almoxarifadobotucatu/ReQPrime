<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Pedidos SUS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin-bottom: 20px; }
    canvas { margin: 20px 0; max-width: 100%; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f6f8fa; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Dashboard de Pedidos SUS</h1>

  <canvas id="pedidosPorUnidade"></canvas>
  <canvas id="pedidosMensais"></canvas>

  <h2>ðŸ“‹ Lista de Pedidos</h2>
  <table id="tabelaPedidos">
    <thead>
      <tr>
        <th>Data</th>
        <th>Unidade</th>
        <th>Setor</th>
        <th>Item</th>
        <th>Quantidade</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const url = "https://raw.githubusercontent.com/almoxarifadobotucatu/portal-projetos/main/pedidos-sus/pedidos.json";

    async function carregarPedidos() {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("Erro ao carregar pedidos.json");
      return resp.json();
    }

    function agruparPorUnidade(pedidos) {
      const mapa = {};
      pedidos.forEach(p => {
        mapa[p.unidade] = (mapa[p.unidade] || 0) + Number(p.quantidade || 0);
      });
      return mapa;
    }

    function agruparPorMes(pedidos) {
      const mapa = {};
      pedidos.forEach(p => {
        const data = new Date(p.data || Date.now());
        const mes = `${data.getFullYear()}-${String(data.getMonth()+1).padStart(2,"0")}`;
        mapa[mes] = (mapa[mes] || 0) + Number(p.quantidade || 0);
      });
      return mapa;
    }

    function preencherTabela(pedidos) {
      const tbody = document.querySelector("#tabelaPedidos tbody");
      tbody.innerHTML = "";
      pedidos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.data || ""}</td>
          <td>${p.unidade || ""}</td>
          <td>${p.setor || ""}</td>
          <td>${p.item || ""}</td>
          <td>${p.quantidade || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function criarGraficos(pedidos) {
      const ctxUnidade = document.getElementById("pedidosPorUnidade").getContext("2d");
      const dadosUnidade = agruparPorUnidade(pedidos);
      new Chart(ctxUnidade, {
        type: "bar",
        data: {
          labels: Object.keys(dadosUnidade),
          datasets: [{
            label: "Pedidos por Unidade",
            data: Object.values(dadosUnidade)
          }]
        }
      });

      const ctxMes = document.getElementById("pedidosMensais").getContext("2d");
      const dadosMes = agruparPorMes(pedidos);
      new Chart(ctxMes, {
        type: "line",
        data: {
          labels: Object.keys(dadosMes),
          datasets: [{
            label: "Pedidos Mensais",
            data: Object.values(dadosMes),
            fill: false,
            borderColor: "blue"
          }]
        }
      });
    }

    carregarPedidos().then(pedidos => {
      preencherTabela(pedidos);
      criarGraficos(pedidos);
    }).catch(err => {
      document.body.innerHTML += "<p style='color:red'>Erro: " + err.message + "</p>";
    });
  </script>
</body>
</html>
