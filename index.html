<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Iniciar sessão</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- bcryptjs para navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
<script>
  // atalho para usar bcrypt normalmente
  const bcrypt = dcodeIO.bcrypt;
</script>

<style>
  /* reset + box sizing */
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; }

  /* fundo neutro para evitar sobrescritas externas */
  body {
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, #0f1724 0%, #071029 100%);
    color: #e6eef8;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .login-container {
    width: 380px;
    max-width: calc(100% - 48px);
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius: 12px;
    padding: 26px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.7);
    backdrop-filter: blur(6px);
  }

  h2 {
    margin: 0 0 14px 0;
    font-size: 1.4rem;
    text-align: center;
    color: #f1f7ff;
  }

  label {
    display: block;
    margin: 12px 0 6px;
    color: #c7d3e6;
    font-size: 0.9rem;
  }

  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02);
    color: #fff;
    font-size: 0.95rem;
  }

  input::placeholder { color: rgba(255,255,255,0.45); }

  .password-wrapper { position: relative; }
  .password-wrapper svg {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    cursor: pointer;
    opacity: 0.95;
  }

  .buttons {
    display: flex;
    gap: 10px;
    margin-top: 18px;
    justify-content: center;
  }

  button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  button[type="submit"] {
    background: #0a84ff;
    color: #fff;
  }

  #btnChangePassword {
    background: #ef4444;
    color: #fff;
  }

  /* modal */
  .modal { display: none; position: fixed; inset: 0; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index: 9999; }
  .modal-content {
    width: 360px;
    max-width: calc(100% - 40px);
    background: linear-gradient(180deg, #071529, #061224);
    padding: 18px;
    border-radius: 10px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }
  .modal-close { float: right; cursor: pointer; color: #9fb3d4; font-size: 18px; }

  footer { position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); font-size: 10px; color: rgba(255,255,255,0.5); user-select: none; }
  @media (max-width:420px) {
    .login-container { width: 100%; padding: 18px; }
  }
</style>
</head>
<body>

<div class="login-container" role="main" aria-labelledby="title">
  <h2 id="title">Iniciar sessão</h2>

  <form id="loginForm" autocomplete="off" novalidate>
    <label for="username">Usuário:</label>
    <input id="username" type="text" required />

    <label for="password">Senha:</label>
    <div class="password-wrapper">
      <input id="password" type="password" required />
      <svg id="togglePassword" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </div>

    <div class="buttons">
      <button type="submit">Entrar</button>
      <button type="button" id="btnChangePassword">Alterar Senha</button>
    </div>
  </form>
</div>

<!-- Modal Alterar Senha -->
<div class="modal" id="passwordModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <span class="modal-close" id="closeModal" title="Fechar">&times;</span>
    <h3 id="modalTitle" style="margin-top:0; color:#e6eef8; text-align:center;">Alterar Senha</h3>

    <label for="currentPassword">Senha atual</label>
    <div class="password-wrapper">
      <input id="currentPassword" type="password" />
      <svg id="toggleCurrentPassword" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </div>

    <label for="newPassword">Nova senha</label>
    <div class="password-wrapper">
      <input id="newPassword" type="password" />
      <svg id="toggleNewPassword" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </div>

    <div style="margin-top:14px; text-align:center;">
      <button id="savePasswordBtn" style="background:#0a84ff;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;">Salvar</button>
    </div>
  </div>
</div>

<footer>© 2025. Todos os direitos reservados.</footer>

<script>
  // FIREBASE init
  const firebaseConfig = {
    apiKey: "AIzaSyCdB4pI610z1rplKmfAHct7CmGD0vmBg3U",
    authDomain: "almoxarifadobotucatu-5e03d.firebaseapp.com",
    projectId: "almoxarifadobotucatu-5e03d",
    storageBucket: "almoxarifadobotucatu-5e03d.firebasestorage.app",
    messagingSenderId: "828951000388",
    appId: "1:828951000388:web:06dbe3cb5764872e7b1311"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // elementos
  const loginForm = document.getElementById("loginForm");
  const passwordInput = document.getElementById("password");
  const togglePassword = document.getElementById("togglePassword");

  const modal = document.getElementById("passwordModal");
  const btnChange = document.getElementById("btnChangePassword");
  const closeModal = document.getElementById("closeModal");
  const savePasswordBtn = document.getElementById("savePasswordBtn");

  // toggle password visibility
  togglePassword.addEventListener("click", () => {
    const type = passwordInput.type === "password" ? "text" : "password";
    passwordInput.type = type;
  });

  // LOGIN
  loginForm.addEventListener("submit", async function(e) {
    e.preventDefault();
    const username = document.getElementById("username").value.trim();
    const password = passwordInput.value.trim();

    if (!username || !password) { alert("Preencha usuário e senha."); return; }

    try {
      const docRef = db.collection("usuarios").doc(username);
      const docSnap = await docRef.get();

      if (!docSnap.exists) { alert("Usuário não encontrado!"); return; }

      const dados = docSnap.data();
      // uso síncrono para compatibilidade
      const senhaConfere = bcrypt.compareSync(password, dados.senhaHash || "");

      if (!senhaConfere) { alert("Senha incorreta!"); return; }

      if (dados.precisaTrocar) {
        alert("Você precisa alterar a senha padrão antes de continuar.");
        btnChange.click();
        return;
      }

      // sucesso: salvar sessão
      sessionStorage.setItem("logado", "true");
      localStorage.setItem("usuarioLogado", username);
      localStorage.setItem("nomeUsuario", dados.nome || username);

      // redireciona (ajuste a URL conforme sua estrutura)
      window.location.href = "/central-de-pedidos/";
    } catch (err) {
      console.error(err);
      alert("Erro ao fazer login: " + (err.message || err));
    }
  });

  // modal alterar senha
  btnChange.addEventListener("click", () => {
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
  });
  closeModal.addEventListener("click", () => {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  });
  window.addEventListener("click", e => { if (e.target === modal) { modal.style.display = "none"; modal.setAttribute("aria-hidden", "true"); } });

  // toggles do modal
  document.getElementById("toggleCurrentPassword").addEventListener("click", () => {
    const el = document.getElementById("currentPassword");
    el.type = el.type === "password" ? "text" : "password";
  });
  document.getElementById("toggleNewPassword").addEventListener("click", () => {
    const el = document.getElementById("newPassword");
    el.type = el.type === "password" ? "text" : "password";
  });

  // salvar nova senha
  savePasswordBtn.addEventListener("click", async () => {
    const usuario = document.getElementById("username").value.trim();
    const currentPass = document.getElementById("currentPassword").value.trim();
    const newPass = document.getElementById("newPassword").value.trim();

    if (!usuario || !currentPass || !newPass) { alert("Preencha todos os campos."); return; }

    try {
      const docRef = db.collection("usuarios").doc(usuario);
      const docSnap = await docRef.get();
      if (!docSnap.exists) { alert("Usuário não encontrado"); return; }
      const dados = docSnap.data();

      const senhaConfere = bcrypt.compareSync(currentPass, dados.senhaHash || "");
      if (!senhaConfere) { alert("Senha atual incorreta"); return; }

      const newHash = bcrypt.hashSync(newPass, bcrypt.genSaltSync(10));
      await docRef.set({ senhaHash: newHash, precisaTrocar: false }, { merge: true });

      alert("Senha alterada com sucesso!");
      modal.style.display = "none";
      document.getElementById("currentPassword").value = "";
      document.getElementById("newPassword").value = "";
    } catch (err) {
      console.error(err);
      alert("Erro ao salvar a senha: " + (err.message || err));
    }
  });

  // pequenas proteções (opcional)
  document.addEventListener('keydown', function (event) {
    if (event.key === "F12" || event.keyCode === 123) { event.preventDefault(); return false; }
  });
</script>

<!--
  Se você estiver usando protege-pagina.js e ele causar overlay:
  descomente abaixo somente depois de revisar esse arquivo.
-->
<!-- <script src="/protege-pagina.js"></script> -->
</body>
</html>
