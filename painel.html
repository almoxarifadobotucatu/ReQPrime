<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Pedidos Extras</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Inter',Arial,sans-serif; background:#1a1a2e; color:#fff; overflow-y: auto; }
    .topbar { display: flex; justify-content: center; align-items: center; padding: 20px; background: #16213e; border-bottom: 2px solid #0a66c2; position: relative; }
    .topbar h1 { margin: 0; font-size: 2.2rem; font-weight: 800; display: flex; align-items: center; gap: 10px; }
    #resetPedidosBtn { position: absolute; right: 20px; }
    .gate { max-width: 1400px; margin: 20px auto; padding: 0 20px; display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: wrap; }
    select,button { padding:10px 14px; border-radius:8px; border:none; font-size:1rem; }
    select { background: #16213e; color: #fff; border: 1px solid #2a2a3a; border-radius: 8px; padding: 10px 14px; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; min-width: 80px; }
    button { background:#0a66c2; color:#fff; font-weight:600; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.2); cursor:pointer; transition:all 0.2s ease; }
    button:hover { background:linear-gradient(270deg,#0a66c2,#1db954); transform:translateY(-2px); }
    #resetPedidosBtn { background:#e53e3e; }
    #resetPedidosBtn:hover { background:linear-gradient(270deg,#e53e3e,#ff6b6b); }
    .export-buttons { display: flex; justify-content: center; gap: 10px; padding: 10px; margin-top: 10px; }
    .export-buttons button { padding: 12px 20px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; }
    #exportExcel { background: #1db954; color: #fff; }
    #exportExcel:hover { background: #17a34a; }
    #exportPDF { background: #e53e3e; color: #fff; }
    #exportPDF:hover { background: #c53030; }
    select:hover { border-color: #0a66c2; }
    select:focus { outline: none; border-color: #0a66c2; box-shadow: 0 0 6px rgba(10,102,194,0.6); }
    option { background: #16213e; color: #fff; }
    #resetPedidosBtn { margin-left: auto; }

    .pedido { background:#16213e; border:1px solid #2a2a3a; border-radius:12px; margin:10px auto; padding:10px; max-width:1400px; }
    .pedido-header { font-weight:600; padding:10px; background:#0a66c2; border-radius:8px; cursor:pointer; }
    .pedido-header span { font-size:1rem; }
    .pedido-status { text-align:right; margin-top:6px; }
    .pedido-itens { display:none; margin-top:10px; }
    .pedido-itens table { width:100%; border-collapse:collapse; table-layout: auto; }
    .pedido-itens th, .pedido-itens td { border-bottom:1px solid #2a2a3a; padding:10px; text-align:left; }
    .pedido-itens th { font-size: 1rem; }
    .pedido-itens td { font-size: 0.95rem; }

    body.light { background: #f5f5f5; color: #000; }
    body.light .topbar { background: #e0e0e0; border-bottom: 2px solid #0a66c2; }
    body.light .pedido { background:#fff; border:1px solid #ccc; }
    body.light select { background:#fff; color:#000; border:1px solid #aaa; }
    body.light option { background:#fff; color:#000; }

    /* Barra do Pedido Extra */
    .pedido-header { font-weight: 600; padding: 10px; background: #4a90e2; border-radius: 8px; cursor: pointer; color: #fff; transition: background 0.3s; }
    .pedido-header:hover { background: #357abd; }
    body.light .pedido-header { background: #b0c4de; color: #000; }
    body.light .pedido-header:hover { background: #91acc9; }

    #toggleThemeBtn { position: absolute; left: 20px; font-size: 0.8rem; padding: 6px 10px; }
  </style>

<style>
  /* Esconde a coluna Setor apenas no dashboard */
  .dashboard-view .col-setor {
    display: none;
  }
</style>

</head>
<body>
  <div class="topbar">
    <button id="toggleThemeBtn">🌞 Modo Claro</button>
    <h1>Painel de Pedidos Extras</h1>
    <button id="resetPedidosBtn">Resetar Pedidos</button>
  </div>

  <div class="gate">
    <label for="unidadeSelect">Selecione a unidade de saúde:</label>
    <select id="unidadeSelect"><option value="">Todas</option></select>
    <button id="confirmarUnidade">Carregar</button>

    <span>Últimos</span>
    <select id="diasFiltro"></select>
    <span>dias</span>
  </div>

  <div id="listaPedidos" style="padding:20px; max-width:1400px; margin:auto;"></div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// === Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyCdB4pI610z1rplKmfAHct7CmGD0vmBg3U",
  authDomain: "almoxarifadobotucatu-5e03d.firebaseapp.com",
  projectId: "almoxarifadobotucatu-5e03d",
  storageBucket: "almoxarifadobotucatu-5e03d.appspot.com",
  messagingSenderId: "828951000388",
  appId: "1:828951000388:web:06dbe3cb5764872e7b1311"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// === Elementos ===
const unidadeSelect = document.getElementById("unidadeSelect");
const confirmarBtn = document.getElementById("confirmarUnidade");
const listaPedidos = document.getElementById("listaPedidos");
const diasFiltro = document.getElementById("diasFiltro");
const toggleBtn = document.getElementById("toggleThemeBtn");

// Preenche filtro de dias
for (let i = 1; i <= 30; i++) {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = i;
  if (i === 30) opt.selected = true;
  diasFiltro.appendChild(opt);
}

// ===== Utilitários =====
function toDateFlex(any){
  if (!any) return null;
  if (any.seconds) return new Date(any.seconds * 1000); // Timestamp Firestore
  if (typeof any === "number") return new Date(any);
  if (typeof any === "string"){
    // Tenta formatar dd/mm/yyyy HH:mm:ss (pt-BR)
    const m = any.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:[^\d](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
    if (m){
      const [ , d, M, y, hh="0", mm="0", ss="0" ] = m;
      const dt = new Date(Number(y), Number(M)-1, Number(d), Number(hh), Number(mm), Number(ss));
      return dt;
    }
  }
  const dt = new Date(any);
  return isNaN(dt.getTime()) ? null : dt;
}

function slugify(txt){
  return (txt||"sem_unidade").toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\s-]/g,'')
    .trim().replace(/\s+/g,'_')
    .toLowerCase();
}
function fmtDate(dt){
  if(!dt) return 'sem_data';
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const d = String(dt.getDate()).padStart(2,'0');
  const hh = String(dt.getHours()).padStart(2,'0');
  const mm = String(dt.getMinutes()).padStart(2,'0');
  return `${y}${m}${d}_${hh}${mm}`;
}

// Mostra apenas números no Código SMAR e remove números do Item
function separarCodigoNome(itemNome){
  if(!itemNome) return {codigo:"—", nome:"—"};
  const s = String(itemNome).trim();

  // Captura até 10 dígitos (com ou sem espaços/hífens) no início
  const m = s.match(/^\s*((?:\d[\s-]*){1,10})\s*(.*)$/);
  if(!m) return { codigo: "—", nome: s };

  const onlyDigits = m[1].replace(/[^\d]/g,'').slice(0,10);
  const rawNome = m[2].trim();

  // Quebra o código em 1-2-2-4-1
  const sizes = [1,2,2,4,1];
  const partes = [];
  let idx = 0;
  for (const size of sizes) {
    if (idx >= onlyDigits.length) break;
    partes.push(onlyDigits.slice(idx, Math.min(idx + size, onlyDigits.length)));
    idx += size;
  }
  const codigo = partes.join(' ');
  return { codigo: codigo || "—", nome: rawNome || "—" };
}

function gerarHTMLPedido(p){
  const titulo = `Pedido Extra – ${p.unidade || '—'} – ${p.data ? p.data.toLocaleString() : '—'}`;
  const linhas = (p.itens||[]).map(it=>{
    const sep = separarCodigoNome(it.nome);
    const q = (it.quantidade ?? "").toString();
    const uc = it.unidadeControle ?? "";
    let setoresArr = [];
    if (Array.isArray(it.setores) && it.setores.length) {
      setoresArr = it.setores;
    } else if (it.setor) {
      setoresArr = [it.setor];
    } else if (Array.isArray(p.setores) && p.setores.length === 1) {
      setoresArr = [p.setores[0]];
    } else if (p.setor) {
      setoresArr = [p.setor];
    } else {
      setoresArr = ["—"];
    }
    return setoresArr.map(setor => `
      <tr>
        <td class="smar">${sep.codigo}</td>
        <td>${escapeHtml(sep.nome)}</td>
        <td>${escapeHtml(q)}</td>
        <td>${escapeHtml(uc)}</td>
        <td class="col-setor">${escapeHtml(setor)}</td></tr>
    `).join("");
  }).join("");

  return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>${escapeHtml(titulo)}</title>
<style>
  body{font-family:Arial, Helvetica, sans-serif; margin:24px;}
  h1{margin:0 0 8px 0; font-size:20px}
  .meta{color:#444; margin:0 0 16px 0}
  table{border-collapse:collapse; width:100%}
  th,td{border:1px solid #bbb; padding:8px; text-align:left}
  th{background:#f2f2f2}
  .smar{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  @media print{body{margin:0} th,td{border-color:#000}}
</style>
</head>
<body>
  <h1>Pedido Extra – ${escapeHtml(p.data ? p.data.toLocaleString() : "—")}</h1>
  <p class="meta"><strong>Responsável pelo Pedido:</strong> ${escapeHtml(p.solicitante||"—")}</p>
  <p class="meta"><strong>Unidade de Saúde:</strong> ${escapeHtml(p.unidade||"—")}</p>
  <table class="dashboard-view">
    <thead>
      <tr><th>Código SMAR</th><th>Item</th><th>Quantidade</th><th>Unidade de Controle</th><th class="col-setor">Setor</th></tr>
    </thead>
    <tbody>
      ${linhas}
    </tbody>
  </table>
</body>
</html>`;
}

function escapeHtml(str){
  return String(str??'').replace(/[&<>\"']/g, s=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'
  })[s]||s);
}

// ===== Renderização =====
function renderizarPedido(p, unidade) {
  const pedidoDiv = document.createElement("div"); pedidoDiv.className="pedido";
  const dataStr = p.data ? p.data.toLocaleString() : "—";
  pedidoDiv.innerHTML = `
    <div class="pedido-header">
      <span>📁 Pedido Extra – ${p.unidade} – ${dataStr}</span>
    </div>
    <div class="pedido-status">
      <label>Status:</label>
      <select class="statusSelect">
        <option value="PENDENTE" ${p.status==="PENDENTE"?"selected":""}>PENDENTE</option>
        <option value="APROVADO" ${p.status==="APROVADO"?"selected":""}>APROVADO</option>
      </select>
    </div>
    <div class="pedido-itens">
      <table class="dashboard-view">
        <tr><th>Código SMAR</th><th>Item</th><th>Quantidade</th><th>Unidade de Controle</th><th class="col-setor">Setor</th></tr>
        ${p.itens.map(it=>{
  const sep = separarCodigoNome(it.nome);
  const q = (it.quantidade ?? "").toString();
  const uc = it.unidadeControle ?? "";
  let setor = "—";
  if (Array.isArray(it.setores) && it.setores.length) setor = it.setores[0];
  else if (it.setor) setor = it.setor;
  else if (Array.isArray(p.setores) && p.setores.length === 1) setor = p.setores[0];
  else if (p.setor) setor = p.setor;
  return `<tr><td class="smar">${sep.codigo}</td><td>${escapeHtml(sep.nome)}</td><td>${escapeHtml(q)}</td><td>${escapeHtml(uc)}</td><td class="col-setor">${escapeHtml(setor)}</td></tr>`;
}).join("")}

      </table>
      <div class="export-buttons">
        <button class="exportPedido">Exportar Pedido</button>
      </div>
    </div>
  `;
  listaPedidos.prepend(pedidoDiv);

  const header = pedidoDiv.querySelector(".pedido-header");
  const itensDiv = pedidoDiv.querySelector(".pedido-itens");
  header.addEventListener("click",()=>{
    itensDiv.style.display = (itensDiv.style.display === "none" || itensDiv.style.display === "") ? "block" : "none";
  });

  const select = pedidoDiv.querySelector(".statusSelect");
  function aplicarCor() {
    if (select.value === "PENDENTE") {
      select.style.background = "gold";
      select.style.color = "#000";
    } else {
      select.style.background = "limegreen";
      select.style.color = "#fff";
    }
  }
  aplicarCor();

  select.addEventListener("change", async ()=>{
    aplicarCor();
    const ref = doc(db,"pedidos",p.id);
    await updateDoc(ref,{ status: select.value });
  });

  // Exportação em HTML
  const btnExport = pedidoDiv.querySelector('.exportPedido');
  btnExport.addEventListener('click', ()=>{
    const html = gerarHTMLPedido(p);
    const blob = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    const unidadeSlug = slugify(p.unidade);
    const ts = fmtDate(p.data);
    a.href = URL.createObjectURL(blob);
    a.download = `pedido_${unidadeSlug}_${ts}.html`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  });
}

// ===== Carregamento / Observação =====
async function carregarUnidades(){
  const snapshot = await getDocs(collection(db,"pedidos"));
  unidadeSelect.innerHTML = '<option value="">Todas</option>';
  const unidades = new Set();
  snapshot.forEach(docSnap => { const u=docSnap.data().unidade; if(u) unidades.add(u); });
  [...unidades].forEach(u=>{
    const opt=document.createElement("option"); opt.value=u; opt.textContent=u; unidadeSelect.appendChild(opt);
  });
}

function aplicarLista(pedidos, unidade){
  const dias = parseInt(diasFiltro.value || 30);
  const dataLimite = new Date();
  dataLimite.setDate(dataLimite.getDate() - dias);

  let filtrados = pedidos
    .filter(p => p.data && p.data >= dataLimite);

  if (unidade) {
    // Unidade específica -> mostra todos
    filtrados = filtrados.filter(p => p.unidade === unidade);
  } else {
    // Todas -> mostra apenas não aprovados
    filtrados = filtrados.filter(p => p.status !== "APROVADO");
  }

  filtrados.sort((a,b)=> (b.data?.getTime?.()||0) - (a.data?.getTime?.()||0));

  listaPedidos.innerHTML = "";
  filtrados.forEach(p => renderizarPedido(p, unidade));
}

async function carregarPedidos(unidade){
  const snapshot = await getDocs(collection(db,"pedidos"));
  const pedidos = [];
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    pedidos.push({
id: docSnap.id,
      solicitante: data.solicitante||"—",
      unidade: data.unidade||"—",
      itens: data.itens || [],
      data: toDateFlex(data.data),
      status: data.status || "PENDENTE",
      setores: Array.isArray(data.setores) ? data.setores : (data.setor ? [data.setor] : []),
      setor: (data.setor ?? data.Setor ?? data.setorPedido ?? "—")
    
});
  });
  aplicarLista(pedidos, unidade);
}

function observarPedidos(unidade){
  const pedidosRef = collection(db, "pedidos");
  if (window.unsubscribePedidos) window.unsubscribePedidos();

  window.unsubscribePedidos = onSnapshot(pedidosRef, (snapshot) => {
    const pedidos = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      pedidos.push({
id: docSnap.id,
      solicitante: data.solicitante||"—",
      unidade: data.unidade||"—",
      itens: data.itens || [],
      data: toDateFlex(data.data),
      status: data.status || "PENDENTE",
      setores: Array.isArray(data.setores) ? data.setores : (data.setor ? [data.setor] : []),
      setor: (data.setor ?? data.Setor ?? data.setorPedido ?? "—")
    
});
    });
    aplicarLista(pedidos, unidade);
  });
}

// ===== Eventos =====
confirmarBtn.addEventListener("click",()=>{
  if (unidadeSelect.value === "") {
    observarPedidos(""); // todas as unidades em tempo real
  } else {
    carregarPedidos(unidadeSelect.value); // apenas a unidade escolhida (snapshot único)
  }
});
diasFiltro.addEventListener("change",()=>{ carregarPedidos(unidadeSelect.value); });

carregarUnidades();
observarPedidos(""); // inicia observando tudo

// Tema claro/escuro
toggleBtn.addEventListener("click", () => {
  document.body.classList.toggle("light");
  if(document.body.classList.contains("light")){
    toggleBtn.textContent = "🌙 Modo Escuro";
  } else {
    toggleBtn.textContent = "🌞 Modo Claro";
  }
});

// === Resetar todos os pedidos ===
const resetBtn = document.getElementById("resetPedidosBtn");
resetBtn.addEventListener("click", async ()=>{
  if (!confirm("Tem certeza que deseja apagar TODOS os pedidos?")) return;
  const snapshot = await getDocs(collection(db,"pedidos"));
  for (const docSnap of snapshot.docs) {
    await deleteDoc(doc(db,"pedidos",docSnap.id));
  }
  alert("Todos os pedidos foram apagados!");
  listaPedidos.innerHTML = "";
});

</script>

</body>
</html>
