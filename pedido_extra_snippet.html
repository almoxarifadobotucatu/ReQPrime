<!-- Cole este script no FINAL da página 'Pedido Extra', logo antes de </body> -->
<script>
(function(){
  function getVal(selectors){
    for(const sel of selectors){
      const el = document.querySelector(sel);
      if(el && typeof el.value === "string") return el.value.trim();
    }
    return "";
  }

  function salvarPedidos(e){
    if(e) e.preventDefault();
    // Coleta dados gerais
    const solicitante = getVal(["#solicitante","[name='solicitante']","[name*='solicitante']"]);
    const unidade = getVal(["#unidade","[name='unidade']","[name*='unidade']"]);

    // Detecta linhas de item (usa vários seletores para se adaptar ao seu HTML)
    const linhas = document.querySelectorAll(".item, .pedido-item, .linha-item, [data-item-row]");
    const pedidosExtras = JSON.parse(localStorage.getItem("pedidosExtras") || "[]");
    const agora = new Date();

    let adicionados = 0;
    linhas.forEach(linha => {
      // Tenta achar o nome do item
      const nomeItem =
        (linha.querySelector(".item-nome-group input") || 
         linha.querySelector("input[name*='item']") ||
         linha.querySelector("input[list]") ||
         linha.querySelector("input[type='text']") ||
         linha.querySelector("textarea"))?.value?.trim() || "";

      // Tenta achar a quantidade
      const qtdEl = (linha.querySelector(".item-qtd-group input") ||
                     linha.querySelector("input[type='number']") ||
                     linha.querySelector("input[name*='qtd']") ||
                     linha.querySelector("input[name*='quant']"));
      const quantidade = qtdEl ? Number(qtdEl.value) : 0;

      // Unidade de medida (opcional)
      const unidadeMedida = (linha.querySelector(".item-unidade-group select") ||
                             linha.querySelector("select[name*='unid']") ||
                             linha.querySelector("select"))?.value || "";

      if(nomeItem && quantidade > 0){
        pedidosExtras.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2),
          solicitante: solicitante || "",
          unidade: unidade || "",
          item: unidadeMedida ? `${nomeItem} (${unidadeMedida})` : nomeItem,
          quantidade: quantidade,
          data: agora.toLocaleDateString("pt-BR"),
          hora: agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })
        });
        adicionados++;
      }
    });

    try {
      localStorage.setItem("pedidosExtras", JSON.stringify(pedidosExtras));
      console.log("[Pedido Extra] Itens adicionados:", adicionados);
      alert(`Salvo! ${adicionados} item(ns) enviado(s) ao Dashboard.`);
    } catch(err){
      console.error("Falha ao salvar no localStorage:", err);
      alert("Não foi possível salvar no navegador. Verifique permissões/privacidade.");
    }
  }

  // Anexa no submit do formulário e no botão (cobre os dois casos)
  const form = document.querySelector("form#pedidoExtraForm") || document.querySelector("form");
  if(form){
    form.addEventListener("submit", salvarPedidos);
  }
  const btn = document.getElementById("enviarPedido") || document.querySelector("[data-enviar-pedido]");
  if(btn){
    btn.addEventListener("click", salvarPedidos);
  }

  // Dica no console sobre a origem (para evitar teste com origens diferentes)
  console.log("[Pedido Extra] Origem:", location.protocol + "//" + location.host);
})();
</script>
